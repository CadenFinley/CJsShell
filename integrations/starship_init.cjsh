STARSHIP_BIN="$(command -v starship 2>/dev/null || true)"

if [ -z "${STARSHIP_BIN}" ]; then
    hash -r 2>/dev/null || true
    STARSHIP_BIN="$(command -v starship 2>/dev/null || true)"
fi

if [ -z "${STARSHIP_BIN}" ] && [ -x "/opt/homebrew/bin/starship" ]; then
    STARSHIP_BIN="/opt/homebrew/bin/starship"
elif [ -z "${STARSHIP_BIN}" ] && [ -x "/usr/local/bin/starship" ]; then
    STARSHIP_BIN="/usr/local/bin/starship"
fi

if [ -z "${STARSHIP_BIN}" ]; then
    return 1 2>/dev/null || exit 1
fi

export STARSHIP_SHELL="bash"  # Use bash for now since cjsh is bash-compatible

# Set up a unique session key for logging
STARSHIP_SESSION_KEY="${RANDOM}${RANDOM}${RANDOM}${RANDOM}${RANDOM}"
STARSHIP_SESSION_KEY="${STARSHIP_SESSION_KEY}0000000000000000"
export STARSHIP_SESSION_KEY="${STARSHIP_SESSION_KEY:0:16}"

# Ensure that COLUMNS gets set
export COLUMNS

# Function to get current time in milliseconds (for command duration tracking)
function starship_time() {
    # Using date command as a fallback since cjsh doesn't have a built-in time function
    # This returns milliseconds since epoch
    if date +%s%3N >/dev/null 2>&1; then
        date +%s%3N
    else
        # Fallback to seconds * 1000 if milliseconds not supported
        echo $(($(date +%s) * 1000))
    fi
}


# Function that runs before executing each command (preexec hook)
function starship_preexec() {
    # Only start the timer if we're ready (prompt was just drawn)
    if [ "${STARSHIP_PREEXEC_READY}" = "true" ]; then
        STARSHIP_PREEXEC_READY=false
        STARSHIP_START_TIME=$(starship_time)
    fi
}

# Function that runs before drawing the prompt (precmd hook)
function starship_precmd() {
    # Save the last command's exit status
    STARSHIP_CMD_STATUS=$?
    
    # Get pipeline status from PIPESTATUS environment variable (set by cjsh)
    if [ -n "${PIPESTATUS}" ]; then
        STARSHIP_PIPE_STATUS="${PIPESTATUS}"
    else
        STARSHIP_PIPE_STATUS="${STARSHIP_CMD_STATUS}"
    fi
    
    # Count background jobs
    NUM_JOBS=0
    for job in $(jobs -p 2>/dev/null); do
        if [ -n "$job" ]; then
            NUM_JOBS=$((NUM_JOBS + 1))
        fi
    done
    
    # Calculate command duration if we have a start time
    STARSHIP_DURATION_ARG=""
    if [ -n "${STARSHIP_START_TIME}" ]; then
        STARSHIP_END_TIME=$(starship_time)
        STARSHIP_DURATION=$((STARSHIP_END_TIME - STARSHIP_START_TIME))
        STARSHIP_DURATION_ARG="--cmd-duration=${STARSHIP_DURATION}"
        STARSHIP_START_TIME=""
    fi
    
    # Generate the primary prompt
    # Note: We call starship with arguments directly, not using array expansion
    if [ -n "${STARSHIP_DURATION_ARG}" ]; then
        export PS1="$("${STARSHIP_BIN}" prompt --terminal-width="${COLUMNS:-80}" --status="${STARSHIP_CMD_STATUS}" --pipestatus="${STARSHIP_PIPE_STATUS}" --jobs="${NUM_JOBS}" --shlvl="${SHLVL:-1}" "${STARSHIP_DURATION_ARG}")"
    else
        export PS1="$("${STARSHIP_BIN}" prompt --terminal-width="${COLUMNS:-80}" --status="${STARSHIP_CMD_STATUS}" --pipestatus="${STARSHIP_PIPE_STATUS}" --jobs="${NUM_JOBS}" --shlvl="${SHLVL:-1}")"
    fi
    
    # Generate the right prompt
    if [ -n "${STARSHIP_DURATION_ARG}" ]; then
        export RPROMPT="$("${STARSHIP_BIN}" prompt --right --terminal-width="${COLUMNS:-80}" --status="${STARSHIP_CMD_STATUS}" --pipestatus="${STARSHIP_PIPE_STATUS}" --jobs="${NUM_JOBS}" --shlvl="${SHLVL:-1}" "${STARSHIP_DURATION_ARG}")"
    else
        export RPROMPT="$("${STARSHIP_BIN}" prompt --right --terminal-width="${COLUMNS:-80}" --status="${STARSHIP_CMD_STATUS}" --pipestatus="${STARSHIP_PIPE_STATUS}" --jobs="${NUM_JOBS}" --shlvl="${SHLVL:-1}")"
    fi
    
    # Signal that we can safely restart the timer on the next command
    STARSHIP_PREEXEC_READY=true
}

# Register the hooks with cjsh's hook system
if command -v hook >/dev/null 2>&1; then
    hook add precmd starship_precmd
    hook add preexec starship_preexec
else
    return 1 2>/dev/null || exit 1
fi

# Set the continuation prompt (PS2)
export PS2="$("${STARSHIP_BIN}" prompt --continuation)"

# Initialize the start time for the first command
STARSHIP_START_TIME=$(starship_time)
STARSHIP_PREEXEC_READY=true
